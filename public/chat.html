<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KAY SPARK - Skill Gap Assistant</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100vh;
        overflow: hidden;
      }

      .app-container {
        display: flex;
        height: 100vh;
        max-width: 100vw;
      }

      /* Sidebar */
      .sidebar {
        width: 280px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-right: 1px solid rgba(102, 126, 234, 0.1);
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease;
        z-index: 1000;
      }

      .sidebar-hidden {
        transform: translateX(-100%);
      }

      .sidebar-header {
        padding: 1rem;
        border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        display: flex;
        align-items: center;
        gap: 0.8rem;
      }

      .sidebar-header .logo-small {
        width: 32px;
        height: 32px;
        border-radius: 50%;
      }

      .sidebar-title {
        font-size: 1rem;
        font-weight: 600;
        color: #667eea;
      }

      .new-chat-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 0.7rem;
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        font-weight: 500;
        margin: 1rem;
        transition: all 0.3s ease;
      }

      .new-chat-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .chat-history {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
      }

      .chat-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.7rem;
        margin-bottom: 0.3rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.8rem;
        position: relative;
      }

      .chat-item:hover {
        background: rgba(102, 126, 234, 0.05);
      }

      .chat-item.active {
        background: rgba(102, 126, 234, 0.1);
        border-left: 3px solid #667eea;
      }

      .chat-title {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #4a5568;
      }

      .chat-actions {
        display: none;
        gap: 0.3rem;
      }

      .chat-item:hover .chat-actions {
        display: flex;
      }

      .chat-action-btn {
        background: none;
        border: none;
        color: #94a3b8;
        cursor: pointer;
        padding: 0.2rem;
        border-radius: 4px;
        font-size: 0.7rem;
        transition: all 0.2s ease;
      }

      .chat-action-btn:hover {
        color: #667eea;
        background: rgba(102, 126, 234, 0.1);
      }

      /* Main Chat Container */
      .main-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
      }

      .chat-container {
        flex: 1;
        background: white;
        border-radius: 0;
        box-shadow: none;
        display: flex;
        flex-direction: column;
        height: 100vh;
        max-height: 100vh;
      }

      /* Chat Header */
      .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        min-height: 60px;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .sidebar-toggle {
        background: none;
        border: none;
        color: white;
        font-size: 1.1rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 6px;
        transition: all 0.3s ease;
      }

      .sidebar-toggle:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .logo-container {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.3);
      }

      .logo-container img {
        width: 28px;
        height: 28px;
        border-radius: 50%;
      }

      .header-info h1 {
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 0.1rem;
      }

      .header-info p {
        opacity: 0.9;
        font-size: 0.8rem;
        font-weight: 400;
      }

      .header-actions {
        display: flex;
        gap: 0.8rem;
        align-items: center;
      }

      .maximize-btn,
      .home-btn {
        color: white;
        text-decoration: none;
        background: none;
        border: 2px solid rgba(255, 255, 255, 0.3);
        padding: 0.5rem 0.8rem;
        border-radius: 20px;
        transition: all 0.3s ease;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        backdrop-filter: blur(10px);
      }

      .maximize-btn:hover,
      .home-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.6);
        transform: translateY(-1px);
      }

      .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #4ade80;
        margin-left: 0.4rem;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* Chat Messages Area */
      .chat-messages {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
        background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
        position: relative;
        font-size: 0.85rem;
      }

      .chat-messages::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 15px;
        background: linear-gradient(
          to bottom,
          rgba(248, 250, 252, 1),
          rgba(248, 250, 252, 0)
        );
        pointer-events: none;
        z-index: 10;
      }

      /* Welcome Section */
      .welcome-section {
        text-align: center;
        margin-bottom: 2rem;
        animation: fadeInUp 1s ease-out 0.3s both;
      }

      .welcome-section h2 {
        color: #667eea;
        font-size: 1.6rem;
        font-weight: 700;
        margin-bottom: 0.6rem;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .welcome-section p {
        color: #64748b;
        font-size: 0.95rem;
        line-height: 1.5;
        max-width: 500px;
        margin: 0 auto;
      }

      /* Document Upload Section */
      .upload-section {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        border: 2px dashed rgba(102, 126, 234, 0.2);
        text-align: center;
        transition: all 0.3s ease;
        animation: fadeInUp 1s ease-out 0.4s both;
      }

      .upload-section:hover {
        border-color: rgba(102, 126, 234, 0.4);
        transform: translateY(-2px);
      }

      .upload-section.dragover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.02);
      }

      .upload-icon {
        font-size: 3rem;
        color: #667eea;
        margin-bottom: 1rem;
      }

      .upload-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.5rem;
      }

      .upload-description {
        color: #64748b;
        margin-bottom: 1.5rem;
        font-size: 0.9rem;
      }

      .upload-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 0.8rem 2rem;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 1rem;
      }

      .upload-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
      }

      .skip-btn {
        background: none;
        border: 2px solid #667eea;
        color: #667eea;
        padding: 0.8rem 2rem;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .skip-btn:hover {
        background: #667eea;
        color: white;
        transform: translateY(-2px);
      }

      .file-input {
        display: none;
      }

      .uploaded-file {
        display: inline-flex;
        align-items: center;
        background: rgba(102, 126, 234, 0.1);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        margin: 0.5rem;
        font-size: 0.8rem;
        color: #667eea;
      }

      .uploaded-file i {
        margin-right: 0.5rem;
      }

      .remove-file {
        background: none;
        border: none;
        color: #dc2626;
        margin-left: 0.5rem;
        cursor: pointer;
        font-size: 0.9rem;
      }

      /* Capabilities Grid */
      .capabilities-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
        animation: fadeInUp 1s ease-out 0.5s both;
      }

      .capability-card {
        background: white;
        padding: 1.3rem;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        text-align: center;
        transition: all 0.4s ease;
        border: 1px solid rgba(102, 126, 234, 0.08);
        position: relative;
        overflow: hidden;
      }

      .capability-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        transform: scaleX(0);
        transition: transform 0.4s ease;
      }

      .capability-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
      }

      .capability-card:hover::before {
        transform: scaleX(1);
      }

      .capability-icon {
        font-size: 1.8rem;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.8rem;
      }

      .capability-card h4 {
        color: #1e293b;
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.6rem;
      }

      .capability-card p {
        color: #64748b;
        line-height: 1.4;
        font-size: 0.8rem;
      }

      /* Quick Questions */
      .quick-questions {
        margin-bottom: 1.5rem;
        animation: fadeInUp 1s ease-out 0.7s both;
      }

      .quick-questions h3 {
        color: #667eea;
        text-align: center;
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
      }

      .question-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
        justify-content: center;
      }

      .question-chip {
        background: white;
        border: 2px solid #667eea;
        color: #667eea;
        padding: 0.6rem 1rem;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.75rem;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.08);
        position: relative;
        overflow: hidden;
      }

      .question-chip::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        transition: left 0.3s ease;
        z-index: -1;
      }

      .question-chip:hover {
        color: white;
        border-color: transparent;
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
      }

      .question-chip:hover::before {
        left: 0;
      }

      /* Message Styles */
      .message {
        margin-bottom: 1rem;
        display: flex;
        align-items: flex-start;
        animation: fadeInUp 0.5s ease-out;
      }

      .message.user {
        justify-content: flex-end;
      }

      .message.ai {
        justify-content: flex-start;
      }

      .message-content {
        max-width: 75%;
        padding: 0.8rem 1.2rem;
        border-radius: 20px;
        word-wrap: break-word;
        font-size: 0.8rem;
        line-height: 1.5;
        position: relative;
      }

      .message.user .message-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 6px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
      }

      .message.ai .message-content {
        background: white;
        color: #1e293b;
        border: 1px solid rgba(102, 126, 234, 0.08);
        border-bottom-left-radius: 6px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
      }

      /* Table Styling */
      .message-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 0.8rem 0;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(102, 126, 234, 0.08);
        font-size: 0.75rem;
      }

      .message-content table th {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 0.6rem 0.8rem;
        font-weight: 600;
        text-align: left;
        font-size: 0.7rem;
      }

      .message-content table td {
        padding: 0.5rem 0.8rem;
        border-bottom: 1px solid rgba(102, 126, 234, 0.08);
        font-size: 0.7rem;
        line-height: 1.4;
      }

      .message-content table tr:last-child td {
        border-bottom: none;
      }

      .message-content table tr:hover {
        background: rgba(102, 126, 234, 0.02);
      }

      /* Typing Indicator */
      .typing-indicator {
        display: none;
        align-items: center;
        margin-bottom: 1rem;
        animation: fadeInUp 0.5s ease-out;
      }

      .typing-dots {
        display: flex;
        align-items: center;
        padding: 0.8rem 1.2rem;
        background: white;
        border: 1px solid rgba(102, 126, 234, 0.08);
        border-radius: 20px;
        border-bottom-left-radius: 6px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
      }

      .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        margin: 0 2px;
        animation: typing 1.4s infinite ease-in-out;
      }

      .dot:nth-child(1) {
        animation-delay: -0.32s;
      }
      .dot:nth-child(2) {
        animation-delay: -0.16s;
      }
      .dot:nth-child(3) {
        animation-delay: 0s;
      }

      @keyframes typing {
        0%,
        80%,
        100% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* Chat Input */
      .chat-input-container {
        padding: 1.2rem;
        background: white;
        border-top: 1px solid rgba(102, 126, 234, 0.08);
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.04);
      }

      .input-wrapper {
        display: flex;
        align-items: flex-end;
        background: #f8fafc;
        border-radius: 24px;
        padding: 0.6rem;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
      }

      .input-wrapper:focus-within {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.08);
        background: white;
      }

      .chat-input {
        flex: 1;
        border: none;
        background: transparent;
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
        outline: none;
        resize: none;
        min-height: 20px;
        max-height: 100px;
        font-family: inherit;
        color: #1e293b;
        line-height: 1.4;
      }

      .chat-input::placeholder {
        color: #94a3b8;
      }

      .input-actions {
        display: flex;
        align-items: center;
        gap: 0.6rem;
      }

      .attachment-btn {
        background: transparent;
        border: none;
        color: #94a3b8;
        font-size: 1rem;
        cursor: pointer;
        padding: 0.4rem;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .attachment-btn:hover {
        color: #667eea;
        background: rgba(102, 126, 234, 0.08);
      }

      .send-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        width: 38px;
        height: 38px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        font-size: 0.9rem;
      }

      .send-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 18px rgba(102, 126, 234, 0.3);
      }

      .send-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      /* Scrollbar Styling */
      .chat-messages::-webkit-scrollbar,
      .chat-history::-webkit-scrollbar {
        width: 4px;
      }

      .chat-messages::-webkit-scrollbar-track,
      .chat-history::-webkit-scrollbar-track {
        background: rgba(102, 126, 234, 0.04);
        border-radius: 2px;
      }

      .chat-messages::-webkit-scrollbar-thumb,
      .chat-history::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 2px;
      }

      /* Animations */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(15px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Fullscreen Mode */
      .fullscreen {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 9999 !important;
        border-radius: 0 !important;
      }

      .fullscreen .sidebar {
        display: none;
      }

      /* Modal for Rename */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }

      .modal {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      .modal h3 {
        margin-bottom: 1rem;
        color: #1e293b;
        font-size: 1.1rem;
      }

      .modal input {
        width: 100%;
        padding: 0.7rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.9rem;
        outline: none;
        margin-bottom: 1rem;
      }

      .modal input:focus {
        border-color: #667eea;
      }

      .modal-actions {
        display: flex;
        gap: 0.8rem;
        justify-content: flex-end;
      }

      .modal-btn {
        padding: 0.6rem 1.2rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .modal-btn.primary {
        background: #667eea;
        color: white;
      }

      .modal-btn.secondary {
        background: #e2e8f0;
        color: #4a5568;
      }

      .modal-btn:hover {
        transform: translateY(-1px);
      }

      /* Processing Indicator */
      .processing-indicator {
        display: none;
        align-items: center;
        gap: 0.8rem;
        background: rgba(102, 126, 234, 0.1);
        padding: 1rem;
        border-radius: 12px;
        margin: 1rem 0;
        color: #667eea;
        font-size: 0.9rem;
      }

      .processing-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(102, 126, 234, 0.3);
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Mobile Responsiveness */
      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          height: 100%;
          z-index: 1001;
          transform: translateX(-100%);
        }

        .sidebar.sidebar-open {
          transform: translateX(0);
        }

        .main-container {
          width: 100%;
        }

        .chat-header {
          padding: 0.8rem 1rem;
        }

        .header-info h1 {
          font-size: 1.1rem;
        }

        .header-actions .home-btn {
          display: none;
        }

        .capabilities-grid {
          grid-template-columns: 1fr;
          gap: 0.8rem;
        }

        .capability-card {
          padding: 1rem;
        }

        .message-content {
          max-width: 90%;
          padding: 0.7rem 1rem;
          font-size: 0.8rem;
        }

        .question-chips {
          flex-direction: column;
          align-items: center;
        }

        .question-chip {
          width: 100%;
          max-width: 240px;
          text-align: center;
        }

        .chat-input-container {
          padding: 1rem;
        }

        .welcome-section h2 {
          font-size: 1.4rem;
        }

        .welcome-section p {
          font-size: 0.85rem;
        }

        .upload-section {
          padding: 1.5rem;
          margin: 1rem 0;
        }

        .upload-icon {
          font-size: 2.5rem;
        }
      }

      @media (max-width: 480px) {
        .chat-messages {
          padding: 1rem;
          font-size: 0.8rem;
        }

        .sidebar {
          width: 260px;
        }

        .message-content table {
          font-size: 0.7rem;
        }

        .message-content table th,
        .message-content table td {
          padding: 0.4rem 0.6rem;
          font-size: 0.65rem;
        }

        .upload-section {
          padding: 1rem;
        }

        .upload-btn,
        .skip-btn {
          display: block;
          width: 100%;
          margin: 0.5rem 0;
        }
      }
      /* Responsive table wrapper */
      .table-responsive {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; /* smooth scroll on iOS */
        margin: 1rem 0;
      }

      /* Ensure the inner table keeps its layout but can scroll */
      .table-responsive table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px; /* desktop baseline */
      }

      /* Adjust min-width at tablet and mobile breakpoints */
      @media (max-width: 1024px) {
        .table-responsive table {
          min-width: 500px;
        }
      }

      @media (max-width: 768px) {
        .table-responsive table {
          min-width: 400px;
        }
      }

      @media (max-width: 480px) {
        .table-responsive table {
          min-width: 300px;
        }
      }

      /* Overlay for mobile sidebar */
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        z-index: 1000;
      }

      @media (max-width: 768px) {
        .sidebar-overlay.show {
          display: block;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Sidebar Overlay for Mobile -->
      <div class="sidebar-overlay" id="sidebarOverlay"></div>

      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <img src="logo.jpg" alt="Logo" class="logo-small" />
          <div class="sidebar-title">KAY SPARK</div>
        </div>

        <button class="new-chat-btn" onclick="createNewChat()">
          <i class="fas fa-plus"></i>
          New Chat
        </button>

        <div class="chat-history" id="chatHistory">
          <div class="chat-item active" data-chat-id="1">
            <i class="fas fa-comments"></i>
            <span class="chat-title">Welcome Chat</span>
            <div class="chat-actions">
              <button
                class="chat-action-btn"
                onclick="renameChat(1)"
                title="Rename"
              >
                <i class="fas fa-edit"></i>
              </button>
              <button
                class="chat-action-btn"
                onclick="deleteChat(1)"
                title="Delete"
              >
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Container -->
      <div class="main-container">
        <div class="chat-container" id="chatContainer">
          <!-- Chat Header -->
          <div class="chat-header">
            <div class="header-left">
              <button class="sidebar-toggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
              </button>
              <div class="logo-container">
                <img src="logo.jpg" alt="KAY SPARK Logo" />
              </div>
              <div class="header-info">
                <h1>KAY SPARK</h1>
                <p>
                  Skill Gap Assistant <span class="status-indicator"></span>
                </p>
              </div>
            </div>
            <div class="header-actions">
              <button
                class="maximize-btn"
                onclick="toggleFullscreen()"
                title="Maximize/Minimize"
              >
                <i class="fas fa-expand" id="maximizeIcon"></i>
              </button>
              <a href="index.html" class="home-btn">
                <i class="fas fa-home"></i> Home
              </a>
            </div>
          </div>

          <!-- Chat Messages -->
          <div class="chat-messages" id="chatMessages">
            <!-- Welcome Section -->
            <div class="welcome-section">
              <h2>Welcome to KAY SPARK! üéØ</h2>
              <p>
                Your intelligent assistant for skill gap analysis and career
                development. I'm here to help you identify skills gaps,
                recommend courses, and create personalized career roadmaps.
              </p>
            </div>

            <!-- Capabilities Grid -->
            <div class="capabilities-grid">
              <div class="capability-card">
                <div class="capability-icon">
                  <i class="fas fa-chart-line"></i>
                </div>
                <h4>Skill Gap Analysis</h4>
                <p>
                  Identify missing skills for your target career based on
                  trending job postings and market demand
                </p>
              </div>
              <div class="capability-card">
                <div class="capability-icon">
                  <i class="fas fa-graduation-cap"></i>
                </div>
                <h4>Course Recommendations</h4>
                <p>
                  Get personalized learning path suggestions from Coursera,
                  Udemy, and Skill India Digital
                </p>
              </div>
              <div class="capability-card">
                <div class="capability-icon">
                  <i class="fas fa-route"></i>
                </div>
                <h4>Career Roadmaps</h4>
                <p>
                  Interactive career planning with step-by-step guidance and
                  milestone tracking
                </p>
              </div>
              <div class="capability-card">
                <div class="capability-icon">
                  <i class="fas fa-file-alt"></i>
                </div>
                <h4>Resume Analysis</h4>
                <p>
                  Get detailed feedback on your resume effectiveness with
                  improvement suggestions
                </p>
              </div>
            </div>

            <!-- Quick Questions -->
            <div class="quick-questions">
              <h3>‚ú® Quick Start Questions</h3>
              <div class="question-chips">
                <div
                  class="question-chip"
                  onclick="sendQuickQuestion('What skills do I need for data science career?')"
                >
                  üî¨ Data Science Skills
                </div>
                <div
                  class="question-chip"
                  onclick="sendQuickQuestion('Create a learning roadmap for web development')"
                >
                  üåê Web Development Path
                </div>
                <div
                  class="question-chip"
                  onclick="sendQuickQuestion('Analyze my resume for software engineer role')"
                >
                  üìÑ Resume Analysis
                </div>
                <div
                  class="question-chip"
                  onclick="sendQuickQuestion('What are the trending tech skills in 2025?')"
                >
                  üöÄ Trending Skills
                </div>
                <div
                  class="question-chip"
                  onclick="sendQuickQuestion('How to transition from marketing to tech?')"
                >
                  üîÑ Career Transition
                </div>
                <div
                  class="question-chip"
                  onclick="sendQuickQuestion('Best certification courses for cloud computing')"
                >
                  ‚òÅÔ∏è Cloud Certifications
                </div>
              </div>
            </div>

            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typingIndicator">
              <div class="typing-dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
              </div>
            </div>
          </div>

          <!-- Chat Input -->
          <div class="chat-input-container">
            <div class="input-wrapper">
              <textarea
                id="chatInput"
                class="chat-input"
                placeholder="Ask me about skills, courses, career paths, resume tips, or anything related to your career development..."
                rows="1"
              ></textarea>
              <div class="input-actions">
                <button
                  class="attachment-btn"
                  onclick="triggerFileUpload()"
                  title="Upload document"
                >
                  <i class="fas fa-paperclip"></i>
                </button>
                <input
                  type="file"
                  id="documentUpload"
                  class="file-input"
                  multiple
                  accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg"
                  onchange="handleFileUpload(event)"
                />
                <button id="sendBtn" class="send-btn" title="Send message">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Rename Modal -->
    <div class="modal-overlay" id="renameModal">
      <div class="modal">
        <h3>Rename Chat</h3>
        <input type="text" id="renameInput" placeholder="Enter new chat name" />
        <div class="modal-actions">
          <button class="modal-btn secondary" onclick="closeRenameModal()">
            Cancel
          </button>
          <button class="modal-btn primary" onclick="confirmRename()">
            Rename
          </button>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let chatMessages = document.getElementById("chatMessages");
      let chatInput = document.getElementById("chatInput");
      let sendBtn = document.getElementById("sendBtn");
      let typingIndicator = document.getElementById("typingIndicator");
      let sidebar = document.getElementById("sidebar");
      let sidebarOverlay = document.getElementById("sidebarOverlay");
      let chatContainer = document.getElementById("chatContainer");
      let maximizeIcon = document.getElementById("maximizeIcon");
      let isFullscreen = false;
      let currentChatId = 1;
      let chatCounter = 1;
      let currentRenameChatId = null;
      let uploadedFiles = new Map(); // Store uploaded files

      // Chat data storage
      let chats = {
        1: {
          id: 1,
          title: "Welcome Chat",
          messages: [],
          files: [],
        },
      };

      // Auto-resize textarea
      chatInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = Math.min(this.scrollHeight, 100) + "px";
      });

      // Send message on Enter (but not Shift+Enter)
      chatInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Send button click
      sendBtn.addEventListener("click", sendMessage);

      // Sidebar functions
      function toggleSidebar() {
        const isMobile = window.innerWidth <= 768;

        if (isMobile) {
          sidebar.classList.toggle("sidebar-open");
          sidebarOverlay.classList.toggle("show");
        } else {
          sidebar.classList.toggle("sidebar-hidden");
        }
      }

      // Close sidebar when clicking overlay
      sidebarOverlay.addEventListener("click", function () {
        sidebar.classList.remove("sidebar-open");
        sidebarOverlay.classList.remove("show");
      });

      // Fullscreen toggle
      function toggleFullscreen() {
        isFullscreen = !isFullscreen;

        if (isFullscreen) {
          chatContainer.classList.add("fullscreen");
          maximizeIcon.className = "fas fa-compress";
        } else {
          chatContainer.classList.remove("fullscreen");
          maximizeIcon.className = "fas fa-expand";
        }
      }

      // Chat management functions
      function createNewChat() {
        chatCounter++;
        const newChatId = chatCounter;
        const newChatTitle = `New Chat ${newChatId}`;

        chats[newChatId] = {
          id: newChatId,
          title: newChatTitle,
          messages: [],
          files: [],
        };

        addChatToHistory(newChatId, newChatTitle);
        switchToChat(newChatId);

        // Close sidebar on mobile after creating new chat
        if (window.innerWidth <= 768) {
          sidebar.classList.remove("sidebar-open");
          sidebarOverlay.classList.remove("show");
        }
      }

      function addChatToHistory(chatId, title) {
        const chatHistory = document.getElementById("chatHistory");
        const chatItem = document.createElement("div");
        chatItem.className = "chat-item";
        chatItem.setAttribute("data-chat-id", chatId);
        chatItem.onclick = () => switchToChat(chatId);

        chatItem.innerHTML = `
                <i class="fas fa-comments"></i>
                <span class="chat-title">${title}</span>
                <div class="chat-actions">
                    <button class="chat-action-btn" onclick="event.stopPropagation(); renameChat(${chatId})" title="Rename">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="chat-action-btn" onclick="event.stopPropagation(); deleteChat(${chatId})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

        chatHistory.appendChild(chatItem);
      }

      function switchToChat(chatId) {
        // Update active chat in sidebar
        document.querySelectorAll(".chat-item").forEach((item) => {
          item.classList.remove("active");
        });

        const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
        if (chatItem) {
          chatItem.classList.add("active");
        }

        currentChatId = chatId;
        loadChatMessages(chatId);
      }

      function loadChatMessages(chatId) {
        const chat = chats[chatId];
        if (!chat) return;

        // Clear current messages
        chatMessages.innerHTML = "";

        // Add welcome content for new chats or show upload section
        if (chat.messages.length === 0) {
          if (chatId === 1) {
            // Show original welcome for first chat
            showWelcomeContent();
          } else {
            // Show upload section for new chats
            showNewChatContent();
          }
        } else {
          // Load saved messages
          chat.messages.forEach((msg) => {
            addMessage(msg.content, msg.sender, false);
          });
        }

        // Always add typing indicator at the end
        const typingDiv = document.createElement("div");
        typingDiv.className = "typing-indicator";
        typingDiv.id = "typingIndicator";
        typingDiv.innerHTML = `
                <div class="typing-dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            `;
        chatMessages.appendChild(typingDiv);

        // Update global reference
        typingIndicator = typingDiv;
      }

      function showWelcomeContent() {
        const welcomeHTML = `
                <div class="welcome-section">
                    <h2>Welcome to KAY SPARK! üéØ</h2>
                    <p>Your intelligent assistant for skill gap analysis and career development. I'm here to help you identify skills gaps, recommend courses, and create personalized career roadmaps.</p>
                </div>

                <div class="capabilities-grid">
                    <div class="capability-card">
                        <div class="capability-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h4>Skill Gap Analysis</h4>
                        <p>Identify missing skills for your target career based on trending job postings and market demand</p>
                    </div>
                    <div class="capability-card">
                        <div class="capability-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <h4>Course Recommendations</h4>
                        <p>Get personalized learning path suggestions from Coursera, Udemy, and Skill India Digital</p>
                    </div>
                    <div class="capability-card">
                        <div class="capability-icon">
                            <i class="fas fa-route"></i>
                        </div>
                        <h4>Career Roadmaps</h4>
                        <p>Interactive career planning with step-by-step guidance and milestone tracking</p>
                    </div>
                    <div class="capability-card">
                        <div class="capability-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <h4>Resume Analysis</h4>
                        <p>Get detailed feedback on your resume effectiveness with improvement suggestions</p>
                    </div>
                </div>

                <div class="quick-questions">
                    <h3>‚ú® Quick Start Questions</h3>
                    <div class="question-chips">
                        <div class="question-chip" onclick="sendQuickQuestion('What skills do I need for data science career?')">
                            üî¨ Data Science Skills
                        </div>
                        <div class="question-chip" onclick="sendQuickQuestion('Create a learning roadmap for web development')">
                            üåê Web Development Path
                        </div>
                        <div class="question-chip" onclick="sendQuickQuestion('Analyze my resume for software engineer role')">
                            üìÑ Resume Analysis
                        </div>
                        <div class="question-chip" onclick="sendQuickQuestion('What are the trending tech skills in 2025?')">
                            üöÄ Trending Skills
                        </div>
                        <div class="question-chip" onclick="sendQuickQuestion('How to transition from marketing to tech?')">
                            üîÑ Career Transition
                        </div>
                        <div class="question-chip" onclick="sendQuickQuestion('Best certification courses for cloud computing')">
                            ‚òÅÔ∏è Cloud Certifications
                        </div>
                    </div>
                </div>
            `;

        chatMessages.innerHTML = welcomeHTML;
      }

      function showNewChatContent() {
        const newChatHTML = `
                <div class="welcome-section">
                    <h2>New Chat Started! üöÄ</h2>
                    <p>Ready to help you with your career development journey. Upload documents for analysis or ask me anything!</p>
                </div>

                <div class="upload-section">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-title">Upload Documents for Analysis</div>
                    <div class="upload-description">
                        Upload your resume, job descriptions, or any career-related documents for personalized analysis and recommendations.
                    </div>
                    <div id="uploadedFilesList"></div>
                    <div>
                        <button class="upload-btn" onclick="triggerFileUpload()">
                            <i class="fas fa-plus"></i> Choose Files
                        </button>
                        <button class="skip-btn" onclick="skipUpload()">Skip for Now</button>
                    </div>
                </div>

                <div class="capabilities-grid">
                    <div class="capability-card">
                        <div class="capability-icon">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <h4>Resume Analysis</h4>
                        <p>Upload your resume for detailed feedback, ATS optimization, and improvement suggestions</p>
                    </div>
                    <div class="capability-card">
                        <div class="capability-icon">
                            <i class="fas fa-briefcase"></i>
                        </div>
                        <h4>Job Description Match</h4>
                        <p>Compare your profile with job requirements and identify skill gaps to address</p>
                    </div>
                    <div class="capability-card">
                        <div class="capability-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <h4>Portfolio Review</h4>
                        <p>Get feedback on your portfolio projects and suggestions for improvement</p>
                    </div>
                    <div class="capability-card">
                        <div class="capability-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <h4>Learning Path</h4>
                        <p>Receive customized course recommendations based on your uploaded documents</p>
                    </div>
                </div>
            `;

        chatMessages.innerHTML = newChatHTML;
      }

      function renameChat(chatId) {
        currentRenameChatId = chatId;
        const chat = chats[chatId];
        const renameInput = document.getElementById("renameInput");

        renameInput.value = chat.title;
        document.getElementById("renameModal").style.display = "flex";
        renameInput.focus();
      }

      function closeRenameModal() {
        document.getElementById("renameModal").style.display = "none";
        currentRenameChatId = null;
      }

      function confirmRename() {
        const newTitle = document.getElementById("renameInput").value.trim();
        if (!newTitle || !currentRenameChatId) return;

        chats[currentRenameChatId].title = newTitle;

        const chatItem = document.querySelector(
          `[data-chat-id="${currentRenameChatId}"] .chat-title`
        );
        if (chatItem) {
          chatItem.textContent = newTitle;
        }

        closeRenameModal();
      }

      function deleteChat(chatId) {
        if (Object.keys(chats).length <= 1) {
          alert("Cannot delete the last chat!");
          return;
        }

        if (confirm("Are you sure you want to delete this chat?")) {
          delete chats[chatId];

          const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
          if (chatItem) {
            chatItem.remove();
          }

          // If deleted chat was current, switch to first available chat
          if (currentChatId === chatId) {
            const firstChatId = parseInt(Object.keys(chats)[0]);
            switchToChat(firstChatId);
          }
        }
      }

      function sendQuickQuestion(question) {
        chatInput.value = question;
        sendMessage();
      }

      // File upload functions
      function triggerFileUpload() {
        document.getElementById("documentUpload").click();
      }

      function handleFileUpload(event) {
        const files = event.target.files;
        const chat = chats[currentChatId];

        for (let file of files) {
          // Store file reference
          chat.files.push({
            name: file.name,
            size: file.size,
            type: file.type,
            lastModified: file.lastModified,
          });

          // Create upload indicator
          showFileUploadIndicator(file);
        }

        // Process files for analysis
        if (files.length > 0) {
          analyzeUploadedFiles(files);
        }
      }

      function showFileUploadIndicator(file) {
        const uploadedFilesList = document.getElementById("uploadedFilesList");
        if (uploadedFilesList) {
          const fileDiv = document.createElement("div");
          fileDiv.className = "uploaded-file";
          fileDiv.innerHTML = `
                    <i class="fas fa-file-alt"></i>
                    ${file.name} (${formatFileSize(file.size)})
                    <button class="remove-file" onclick="removeFile('${
                      file.name
                    }')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
          uploadedFilesList.appendChild(fileDiv);
        }
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function removeFile(fileName) {
        const chat = chats[currentChatId];
        chat.files = chat.files.filter((file) => file.name !== fileName);

        // Remove from UI
        const uploadedFilesList = document.getElementById("uploadedFilesList");
        if (uploadedFilesList) {
          const fileElements =
            uploadedFilesList.querySelectorAll(".uploaded-file");
          fileElements.forEach((element) => {
            if (element.textContent.includes(fileName)) {
              element.remove();
            }
          });
        }
      }

      function analyzeUploadedFiles(files) {
        // Simulate file analysis
        const fileAnalysis = Array.from(files)
          .map((file) => {
            return `üìÑ **${file.name}** (${formatFileSize(file.size)})`;
          })
          .join("\n");

        const analysisMessage = `I've received your files:\n\n${fileAnalysis}\n\nI'm ready to analyze these documents! I can help you with:\n\n‚Ä¢ **Resume Review** - ATS optimization and improvement suggestions\n‚Ä¢ **Skill Gap Analysis** - Compare your skills with job requirements\n‚Ä¢ **Career Recommendations** - Personalized learning paths\n‚Ä¢ **Portfolio Feedback** - Suggestions for project improvements\n\nWhat would you like me to focus on first?`;

        // Add the analysis message
        setTimeout(() => {
          addMessage(analysisMessage, "ai", true);
        }, 1000);
      }

      function skipUpload() {
        // Remove upload section and show normal chat interface
        const uploadSection = document.querySelector(".upload-section");
        if (uploadSection) {
          uploadSection.style.display = "none";
        }

        addMessage(
          "I'm ready to help you with your career development! Feel free to ask me about skills, courses, career paths, or anything else related to your professional growth.",
          "ai",
          true
        );
      }

      async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;

        // Add user message
        addMessage(message, "user", true);
        chatInput.value = "";
        chatInput.style.height = "auto";

        // Show typing indicator
        showTyping();

        // Disable send button
        sendBtn.disabled = true;

        try {
          const chat = chats[currentChatId];
          const contextMessage =
            chat.files.length > 0
              ? `Context: I have uploaded ${
                  chat.files.length
                } document(s): ${chat.files
                  .map((f) => f.name)
                  .join(", ")}. User question: ${message}`
              : message;

          const response = await fetch("/api/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              messages: [
                {
                  role: "system",
                  content: `You are KAY SPARK, a highly skilled educational AI assistant specializing in skill gap analysis and career development. 

Your core expertise includes:

üéØ SKILL GAP ANALYSIS:
- Identify missing skills based on career goals and current abilities
- Compare skills against job market requirements
- Provide gap analysis reports with actionable insights
- Analyze trending job postings and skill demands

üìö COURSE RECOMMENDATIONS:
- Suggest relevant online courses from platforms like Coursera, Udemy, Skill India Digital, edX, Pluralsight
- Recommend certifications aligned with career goals
- Create structured learning paths with timelines
- Provide budget-friendly alternatives and free resources

üó∫Ô∏è CAREER ROADMAPS:
- Design step-by-step career progression plans
- Set realistic milestones and timelines
- Identify transitional skills for career changes
- Map skills to specific job roles and industries

üìÑ RESUME & DOCUMENT ANALYSIS:
- Analyze resume effectiveness for specific roles
- Suggest improvements in content, format, and keywords
- Recommend skills highlighting strategies
- Guide LinkedIn profile optimization
- Review portfolios and project documentation

üîç MARKET INSIGHTS:
- Share current job market trends
- Provide salary insights and growth projections
- Identify emerging skills and technologies
- Compare different career paths

Format your responses with:
- Clear headings and bullet points
- Practical, actionable advice
- Specific course/certification recommendations with links when possible
- Step-by-step guidance
- Motivational and encouraging tone
- Use relevant emojis to enhance readability
- When presenting tabular data, use Markdown table format with proper | separators

Always be thorough, practical, and focused on helping users advance their careers through strategic skill development.`,
                },
                {
                  role: "user",
                  content: contextMessage,
                },
              ],
              maxTokens: 1000,
              temperature: 0.7,
              mode: "education",
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          // Hide typing indicator
          hideTyping();

          // Add AI response
          addMessage(data.response, "ai", true);
        } catch (error) {
          console.error("Error:", error);
          hideTyping();
          addMessage(
            "I apologize, but I'm having trouble connecting right now. Please check your internet connection and try again in a moment. üîÑ",
            "ai",
            true
          );
        } finally {
          // Re-enable send button
          sendBtn.disabled = false;
        }
      }

      function addMessage(content, sender, saveToChat = true) {
        // Remove welcome content when first message is sent
        if (sender === "user") {
          const welcomeSection = document.querySelector(".welcome-section");
          const uploadSection = document.querySelector(".upload-section");
          const capabilitiesGrid = document.querySelector(".capabilities-grid");
          const quickQuestions = document.querySelector(".quick-questions");

          if (welcomeSection) welcomeSection.remove();
          if (uploadSection) uploadSection.remove();
          if (capabilitiesGrid) capabilitiesGrid.remove();
          if (quickQuestions) quickQuestions.remove();
        }

        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}`;

        const messageContent = document.createElement("div");
        messageContent.className = "message-content";

        // Format the content (convert markdown-like formatting)
        const formattedContent = formatMessage(content);
        messageContent.innerHTML = formattedContent;

        messageDiv.appendChild(messageContent);

        // Find typing indicator and insert before it
        const currentTypingIndicator =
          document.getElementById("typingIndicator");
        if (
          currentTypingIndicator &&
          currentTypingIndicator.parentNode === chatMessages
        ) {
          chatMessages.insertBefore(messageDiv, currentTypingIndicator);
        } else {
          // If typing indicator not found, append to end
          chatMessages.appendChild(messageDiv);
        }

        // Save to chat history
        if (saveToChat) {
          chats[currentChatId].messages.push({
            content: content,
            sender: sender,
            timestamp: new Date(),
          });

          // Update chat title based on first user message
          if (
            sender === "user" &&
            chats[currentChatId].messages.filter((m) => m.sender === "user")
              .length === 1
          ) {
            const newTitle =
              content.substring(0, 30) + (content.length > 30 ? "..." : "");
            chats[currentChatId].title = newTitle;

            const chatItem = document.querySelector(
              `[data-chat-id="${currentChatId}"] .chat-title`
            );
            if (chatItem) {
              chatItem.textContent = newTitle;
            }
          }
        }

        // Scroll to bottom smoothly
        chatMessages.scrollTo({
          top: chatMessages.scrollHeight,
          behavior: "smooth",
        });
      }

      function formatMessage(content) {
        // Convert ‚Äú## Heading‚Äù to <h2>
        content = content.replace(
          /^##\s(.+)$/gm,
          '<h2 style="color:#667eea; font-size:1rem; margin:1rem 0;">$1</h2>'
        );

        // Convert ‚Äú> quote‚Äù to <blockquote>
        content = content.replace(
          /^>\s(.+)$/gm,
          '<blockquote style="border-left:3px solid #667eea; margin:0.8rem 0; padding-left:1rem; color:#4a5568;">$1</blockquote>'
        );

        // Existing conversions...
        content = convertMarkdownTables(content);
        return content
          .replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>")
          .replace(/\*([^*]+)\*/g, "<em>$1</em>")
          .replace(
            /`([^`]+)`/g,
            '<code style="background:rgba(102,126,234,0.1);padding:2px 4px;border-radius:3px;font-family:monospace;font-size:0.75rem;" class="table-responsive">$1</code>'
          )
          .replace(/\n\n/g, "</p><p>")
          .replace(/\n/g, "<br>")
          .replace(/^(.+)$/g, "<p>$1</p>")
          .replace(/- ([^\n]+)/g, "‚Ä¢ $1")
          .replace(/(\d+)\.\s([^\n]+)/g, "<strong>$1.</strong> $2")
          .replace(/(#{1,6})\s*([^\n]+)/g, (m, hashes, text) => {
            const level = hashes.length;
            const color = level === 1 ? "#667eea" : "#64748b";
            const fontSize = level === 1 ? "0.95rem" : "0.85rem";
            return `<h${level} style="color:${color};margin:0.8rem 0 0.4rem 0;font-weight:600;font-size:${fontSize};">${text}</h${level}>`;
          });
      }

      function convertMarkdownTables(content) {
        const lines = content.split("\n");
        let result = [];
        let inTable = false;
        let tableRows = [];

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();

          if (line.includes("|") && !line.startsWith(">")) {
            if (!inTable) {
              inTable = true;
              tableRows = [];
            }

            if (!/^[\|\-\s:]+$/.test(line)) {
              tableRows.push(line);
            }
          } else {
            if (inTable) {
              if (tableRows.length > 0) {
                result.push(convertTableRowsToHTML(tableRows));
              }
              inTable = false;
              tableRows = [];
            }
            result.push(line);
          }
        }

        if (inTable && tableRows.length > 0) {
          result.push(convertTableRowsToHTML(tableRows));
        }

        return result.join("\n");
      }

      function convertTableRowsToHTML(rows) {
        if (rows.length === 0) return "";

        let html = "<table class='table-responsive' style='width:100%;border-collapse:collapse;margin:1rem 0;'><tbody>";

        for (let i = 0; i < rows.length; i++) {
          const cells = rows[i]
            .split("|")
            .map((cell) => cell.trim())
            .filter((cell) => cell !== "");

          if (i === 0) {
            html += "<thead><tr>";
            for (const cell of cells) {
              html += `<th>${cell}</th>`;
            }
            html += "</tr></thead><tbody>";
          } else {
            html += "<tr>";
            for (const cell of cells) {
              html += `<td>${cell}</td>`;
            }
            html += "</tr>";
          }
        }

        html += "</tbody></table>";
        return html;
      }

      function showTyping() {
        if (typingIndicator) {
          typingIndicator.style.display = "flex";
          chatMessages.scrollTo({
            top: chatMessages.scrollHeight,
            behavior: "smooth",
          });
        }
      }

      function hideTyping() {
        if (typingIndicator) {
          typingIndicator.style.display = "none";
        }
      }

      // Focus on input when page loads
      window.addEventListener("load", () => {
        chatInput.focus();
      });

      // Handle window resize
      window.addEventListener("resize", () => {
        if (window.innerWidth > 768) {
          sidebar.classList.remove("sidebar-open");
          sidebarOverlay.classList.remove("show");
        }
      });

      // Handle ESC key for modals and fullscreen
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          if (document.getElementById("renameModal").style.display === "flex") {
            closeRenameModal();
          } else if (isFullscreen) {
            toggleFullscreen();
          } else if (
            window.innerWidth <= 768 &&
            sidebar.classList.contains("sidebar-open")
          ) {
            sidebar.classList.remove("sidebar-open");
            sidebarOverlay.classList.remove("show");
          }
        }
      });

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        // Auto-hide sidebar on mobile
        if (window.innerWidth <= 768) {
          sidebar.classList.add("sidebar-hidden");
        }

        // Initialize typing indicator reference
        typingIndicator = document.getElementById("typingIndicator");
      });
    </script>
  </body>
</html>
